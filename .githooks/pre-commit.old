#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

"$repo_root/scripts/agent-log/ensure-agent-log.sh"

log_file="$repo_root/plans/agent-log.md"

has_entry="$(
  awk '
    BEGIN { in_entries=0; found=0 }
    /^## Entries[[:space:]]*$/ { in_entries=1; next }
    /^##[[:space:]]+/ { in_entries=0 }
    in_entries && $0 ~ /^- / { found=1 }
    END { print found }
  ' "$log_file"
)"

if [[ "$has_entry" != "1" ]]; then
  echo "ERROR: Missing required coordination entry in plans/agent-log.md" >&2
  echo "Add at least one bullet under the '## Entries' section before committing." >&2
  exit 1
fi

with_node="$repo_root/.lefthook/with-node-22.sh"
lefthook_js="$repo_root/node_modules/lefthook/bin/index.js"

if [[ -f "$lefthook_js" ]]; then
  if [[ -f "$with_node" ]]; then
    bash "$with_node" node "$lefthook_js" run pre-commit
  else
    node "$lefthook_js" run pre-commit
  fi
elif command -v lefthook >/dev/null 2>&1; then
  lefthook run pre-commit
else
  echo "Warning: lefthook is not installed; skipping pre-commit checks." >&2
  echo "Run: yarn install" >&2
fi
