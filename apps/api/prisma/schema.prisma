generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [btree_gin, pg_trgm]
}

model Entity {
  entityId               String       @id @default(dbgenerated("gen_random_uuid()")) @map("entity_id") @db.Uuid
  name                   String       @db.VarChar(255)
  type                   EntityType
  aliases                String[]     @default([])
  restaurantAttributes   String[]     @default([]) @map("restaurant_attributes") @db.Uuid
  restaurantQualityScore Decimal?     @default(0) @map("restaurant_quality_score") @db.Decimal(10, 4)
  generalPraiseUpvotes   Int          @default(0) @map("general_praise_upvotes")
  latitude               Decimal?     @db.Decimal(10, 8)
  longitude              Decimal?     @db.Decimal(11, 8)
  address                String?      @db.VarChar(500)
  googlePlaceId          String?      @unique @map("google_place_id") @db.VarChar(255)
  restaurantMetadata     Json         @default("{}") @map("restaurant_metadata")
  lastUpdated            DateTime     @default(now()) @map("last_updated")
  createdAt              DateTime     @default(now()) @map("created_at")
  foodConnections        Connection[] @relation("FoodEntity")
  restaurantConnections  Connection[] @relation("RestaurantEntity")

  @@unique([name, type])
  @@index([type], map: "idx_entities_type")
  @@index([type, restaurantQualityScore(sort: Desc)], map: "idx_entities_type_score")
  @@index([name], map: "idx_entities_name")
  @@index([aliases], map: "idx_entities_aliases")
  @@index([restaurantAttributes], map: "idx_entities_restaurant_attributes")
  @@index([longitude, latitude], map: "idx_entities_location")
  @@index([address], map: "idx_entities_address")
  @@index([googlePlaceId], map: "idx_entities_google_place_id")
  @@index([lastUpdated(sort: Desc)], map: "idx_entities_last_updated")
  @@index([createdAt(sort: Desc)], map: "idx_entities_created_at")
  @@map("entities")
}

model Connection {
  connectionId       String        @id @default(dbgenerated("gen_random_uuid()")) @map("connection_id") @db.Uuid
  restaurantId       String        @map("restaurant_id") @db.Uuid
  foodId             String        @map("food_id") @db.Uuid
  categories         String[]      @default([]) @db.Uuid
  foodAttributes     String[]      @default([]) @map("food_attributes") @db.Uuid
  mentionCount       Int           @default(0) @map("mention_count")
  totalUpvotes       Int           @default(0) @map("total_upvotes")
  recentMentionCount Int           @default(0) @map("recent_mention_count")
  lastMentionedAt    DateTime?     @map("last_mentioned_at")
  activityLevel      ActivityLevel @default(normal) @map("activity_level")
  foodQualityScore   Decimal       @default(0) @map("food_quality_score") @db.Decimal(10, 4)
  decayedMentionScore Decimal      @default(0) @map("decayed_mention_score") @db.Decimal(18, 6)
  decayedUpvoteScore  Decimal      @default(0) @map("decayed_upvote_score") @db.Decimal(18, 6)
  decayedScoresUpdatedAt DateTime? @map("decayed_scores_updated_at")
  boostLastAppliedAt DateTime?     @map("boost_last_applied_at")
  lastUpdated        DateTime      @default(now()) @map("last_updated")
  createdAt          DateTime      @default(now()) @map("created_at")
  food               Entity        @relation("FoodEntity", fields: [foodId], references: [entityId])
  restaurant         Entity        @relation("RestaurantEntity", fields: [restaurantId], references: [entityId])

  @@unique([restaurantId, foodId, foodAttributes], map: "connections_restaurant_id_food_id_food_attribut_key")
  @@index([restaurantId], map: "idx_connections_restaurant")
  @@index([foodId], map: "idx_connections_food")
  @@index([categories], map: "idx_connections_categories_gin", type: Gin)
  @@index([foodAttributes], map: "idx_connections_attributes_gin", type: Gin)
  @@index([mentionCount(sort: Desc)], map: "idx_connections_mention_count")
  @@index([totalUpvotes(sort: Desc)], map: "idx_connections_total_upvotes")
  @@index([foodQualityScore(sort: Desc)], map: "idx_connections_quality_score")
  @@index([lastMentionedAt(sort: Desc)], map: "idx_connections_last_mentioned")
  @@index([activityLevel], map: "idx_connections_activity")
  @@index([restaurantId, foodQualityScore(sort: Desc)], map: "idx_connections_restaurant_quality")
  @@index([foodId, foodQualityScore(sort: Desc)], map: "idx_connections_food_quality")
  @@index([restaurantId, mentionCount(sort: Desc)], map: "idx_connections_restaurant_mentions")
  @@index([foodId, mentionCount(sort: Desc)], map: "idx_connections_food_mentions")
  @@index([lastUpdated(sort: Desc)], map: "idx_connections_last_updated")
  @@index([createdAt(sort: Desc)], map: "idx_connections_created_at")
  @@index([recentMentionCount(sort: Desc)], map: "idx_connections_recent_mentions")
  @@map("connections")
}

model ConnectionEntityDetails {
  restaurantName          String        @map("restaurant_name")
  restaurantAliases       String[]      @map("restaurant_aliases")
  restaurantQualityScore  Decimal?      @map("restaurant_quality_score") @db.Decimal(10, 4)
  foodName                String        @map("food_name")
  foodAliases             String[]      @map("food_aliases")
  foodQualityScore        Decimal       @map("food_quality_score") @db.Decimal(10, 4)
  connectionId            String        @id @map("connection_id") @db.Uuid
  restaurantId            String        @map("restaurant_id") @db.Uuid
  foodId                  String        @map("food_id") @db.Uuid
  categories              String[]      @map("categories") @db.Uuid
  foodAttributes          String[]      @map("food_attributes") @db.Uuid
  activityLevel           ActivityLevel @map("activity_level")
  decayedUpvoteScore      Decimal       @map("decayed_upvote_score") @db.Decimal(18, 6)
  decayedMentionScore     Decimal       @map("decayed_mention_score") @db.Decimal(18, 6)
  totalUpvotes            Int           @map("total_upvotes")
  mentionCount            Int           @map("mention_count")
  recentMentionCount      Int           @map("recent_mention_count")
  lastMentionedAt         DateTime?     @map("last_mentioned_at")
  decayedScoresUpdatedAt  DateTime?     @map("decayed_scores_updated_at")
  boostLastAppliedAt      DateTime?     @map("boost_last_applied_at")
  lastUpdated             DateTime      @map("last_updated")
  createdAt               DateTime      @map("created_at")

  @@map("connection_entity_details")
}

model Boost {
  boostId          String    @id @default(dbgenerated("gen_random_uuid()")) @map("boost_id") @db.Uuid
  restaurantId     String    @map("restaurant_id") @db.Uuid
  categoryId       String    @map("category_id") @db.Uuid
  foodAttributeIds String[]  @default([]) @map("food_attribute_ids") @db.Uuid
  mentionCreatedAt DateTime  @map("mention_created_at")
  upvotes          Int       @default(0)
  createdAt        DateTime  @default(now()) @map("created_at")

  @@index([restaurantId, categoryId, mentionCreatedAt], map: "idx_boosts_restaurant_category_time")
  @@index([categoryId], map: "idx_boosts_category")
  @@index([restaurantId], map: "idx_boosts_restaurant")
  @@index([foodAttributeIds], map: "idx_boosts_food_attributes", type: Gin)
  @@map("boosts")
}

model CategoryAggregate {
  restaurantId         String   @map("restaurant_id") @db.Uuid
  categoryId           String   @map("category_id") @db.Uuid
  mentionsCount        Int      @default(0) @map("mentions_count")
  totalUpvotes         Int      @default(0) @map("total_upvotes")
  lastMentionedAt      DateTime @map("last_mentioned_at")
  firstMentionedAt     DateTime @default(now()) @map("first_mentioned_at")
  decayedMentionScore  Decimal  @default(0) @map("decayed_mention_score") @db.Decimal(18, 6)
  decayedUpvoteScore   Decimal  @default(0) @map("decayed_upvote_score") @db.Decimal(18, 6)
  decayedScoresUpdatedAt DateTime? @map("decayed_scores_updated_at")

  @@id([restaurantId, categoryId])
  @@index([categoryId], map: "idx_category_aggregate_category")
  @@index([restaurantId, totalUpvotes(sort: Desc)], map: "idx_category_aggregate_restaurant")
  @@map("category_aggregates")
}

model Source {
  sourceId    String   @map("source_id") @db.VarChar(64)
  pipeline    String   @db.VarChar(32)
  subreddit   String?  @db.VarChar(100)
  processedAt DateTime @default(now()) @map("processed_at")

  @@id([pipeline, sourceId])
  @@index([pipeline], map: "idx_source_pipeline")
  @@index([subreddit], map: "idx_source_subreddit")
  @@index([processedAt(sort: Desc)], map: "idx_source_processed_at")
  @@map("source")
}

model User {
  userId             String             @id @default(dbgenerated("gen_random_uuid()")) @map("user_id") @db.Uuid
  email              String             @unique @db.VarChar(255)
  createdAt          DateTime           @default(now()) @map("created_at")
  trialStartedAt     DateTime?          @map("trial_started_at")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  subscriptionStatus SubscriptionStatus @default(trialing) @map("subscription_status")
  stripeCustomerId   String?            @map("stripe_customer_id") @db.VarChar(255)
  referralCode       String?            @unique @map("referral_code") @db.VarChar(50)
  referredBy         String?            @map("referred_by") @db.Uuid
  subscriptions      Subscription[]
  events             UserEvent[]
  referrer           User?              @relation("UserReferrals", fields: [referredBy], references: [userId])
  referrals          User[]             @relation("UserReferrals")

  @@index([email], map: "idx_users_email")
  @@index([subscriptionStatus], map: "idx_users_subscription_status")
  @@index([createdAt(sort: Desc)], map: "idx_users_created_at")
  @@index([trialEndsAt], map: "idx_users_trial_ends_at")
  @@index([referralCode], map: "idx_users_referral_code")
  @@index([referredBy], map: "idx_users_referred_by")
  @@map("users")
}

model Subscription {
  subscriptionId       String             @id @default(dbgenerated("gen_random_uuid()")) @map("subscription_id") @db.Uuid
  userId               String             @map("user_id") @db.Uuid
  stripeSubscriptionId String?            @unique @map("stripe_subscription_id") @db.VarChar(255)
  status               SubscriptionStatus
  currentPeriodStart   DateTime?          @map("current_period_start")
  currentPeriodEnd     DateTime?          @map("current_period_end")
  cancelAtPeriodEnd    Boolean            @default(false) @map("cancel_at_period_end")
  cancelledAt          DateTime?          @map("cancelled_at")
  createdAt            DateTime           @default(now()) @map("created_at")
  user                 User               @relation(fields: [userId], references: [userId])

  @@index([userId], map: "idx_subscriptions_user_id")
  @@index([status], map: "idx_subscriptions_status")
  @@index([currentPeriodEnd], map: "idx_subscriptions_period_end")
  @@index([stripeSubscriptionId], map: "idx_subscriptions_stripe_id")
  @@index([createdAt(sort: Desc)], map: "idx_subscriptions_created_at")
  @@map("subscriptions")
}

model UserEvent {
  eventId   String   @id @default(dbgenerated("gen_random_uuid()")) @map("event_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  eventType String   @map("event_type") @db.VarChar(50)
  eventData Json     @default("{}") @map("event_data")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [userId])

  @@index([userId], map: "idx_user_events_user_id")
  @@index([eventType], map: "idx_user_events_event_type")
  @@index([createdAt(sort: Desc)], map: "idx_user_events_created_at")
  @@index([userId, eventType], map: "idx_user_events_user_type")
  @@index([userId, createdAt(sort: Desc)], map: "idx_user_events_user_created")
  @@map("user_events")
}

model Subreddit {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String    @unique @db.VarChar(100)
  avgPostsPerDay   Float     @map("avg_posts_per_day")
  lastCalculated   DateTime  @map("last_calculated") @db.Timestamptz(6)
  lastProcessed    DateTime? @map("last_processed") @db.Timestamptz(6)
  isActive         Boolean   @default(true) @map("is_active")
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  safeIntervalDays Float     @map("safe_interval_days")

  @@index([name])
  @@index([isActive])
  @@index([lastProcessed])
  @@index([safeIntervalDays])
  @@map("subreddits")
}

enum EntityType {
  restaurant
  food
  food_attribute
  restaurant_attribute

  @@map("entity_type")
}

enum ActivityLevel {
  trending
  active
  normal

  @@map("activity_level")
}

enum SubscriptionStatus {
  trialing
  active
  cancelled
  expired

  @@map("subscription_status")
}

enum MentionSource {
  post
  comment

  @@map("mention_source")
}
