generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "darwin"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [btree_gin, pg_trgm]
}

model Entity {
  entityId                   String                @id @default(dbgenerated("gen_random_uuid()")) @map("entity_id") @db.Uuid
  name                       String                @db.VarChar(255)
  type                       EntityType
  locationKey                String                @default("global") @map("location_key") @db.VarChar(255)
  aliases                    String[]              @default([])
  restaurantAttributes       String[]              @default([]) @map("restaurant_attributes") @db.Uuid
  restaurantQualityScore     Decimal?              @default(0) @map("restaurant_quality_score") @db.Decimal(10, 4)
  latitude                   Decimal?              @db.Decimal(10, 8)
  longitude                  Decimal?              @db.Decimal(11, 8)
  address                    String?               @db.VarChar(500)
  googlePlaceId              String?               @unique @map("google_place_id") @db.VarChar(255)
  restaurantMetadata         Json?                 @map("restaurant_metadata")
  primaryLocationId          String?               @unique @map("primary_location_id") @db.Uuid
  lastUpdated                DateTime              @default(now()) @map("last_updated")
  createdAt                  DateTime              @default(now()) @map("created_at")
  generalPraiseUpvotes       Int?                  @default(0) @map("general_praise_upvotes")
  city                       String?               @map("city") @db.VarChar(255)
  region                     String?               @map("region") @db.VarChar(255)
  country                    String?               @map("country") @db.VarChar(2)
  postalCode                 String?               @map("postal_code") @db.VarChar(32)
  priceLevel                 Int?                  @map("price_level")
  priceLevelUpdatedAt        DateTime?             @map("price_level_updated_at")
  lastPolledAt               DateTime?             @map("last_polled_at")
  foodConnections            Connection[]          @relation("FoodEntity")
  restaurantConnections      Connection[]          @relation("RestaurantEntity")
  priorityMetrics            EntityPriorityMetric?
  onDemandRequests           OnDemandRequest[]
  pollOptionCategories       PollOption[]          @relation("PollOptionCategoryEntity")
  pollOptions                PollOption[]          @relation("PollOptionPrimaryEntity")
  pollOptionFoods            PollOption[]          @relation("PollOptionFoodEntity")
  pollOptionRestaurants      PollOption[]          @relation("PollOptionRestaurantEntity")
  pollTopicDishTargets       PollTopic[]           @relation("PollTopicTargetDish")
  pollTopicRestaurantTargets PollTopic[]           @relation("PollTopicTargetRestaurant")
  searchLogs                 SearchLog[]
  userFavorites              UserFavorite[]
  restaurantViews            RestaurantView[]
  locations                  RestaurantLocation[]  @relation("RestaurantLocations")
  primaryLocation            RestaurantLocation?   @relation("PrimaryLocation", fields: [primaryLocationId], references: [locationId])

  @@unique([name, type, locationKey])
  @@index([type], map: "idx_entities_type")
  @@index([type, restaurantQualityScore(sort: Desc)], map: "idx_entities_type_score")
  @@index([name], map: "idx_entities_name")
  @@index([locationKey], map: "idx_entities_location_key")
  @@index([aliases], map: "idx_entities_aliases")
  @@index([restaurantAttributes], map: "idx_entities_restaurant_attributes")
  @@index([longitude, latitude], map: "idx_entities_location")
  @@index([address], map: "idx_entities_address")
  @@index([googlePlaceId], map: "idx_entities_google_place_id")
  @@index([city], map: "idx_entities_city")
  @@index([region], map: "idx_entities_region")
  @@index([country], map: "idx_entities_country")
  @@index([priceLevel], map: "idx_entities_price_level")
  @@index([lastPolledAt], map: "idx_entities_last_polled_at")
  @@index([primaryLocationId], map: "idx_entities_primary_location")
  @@index([lastUpdated(sort: Desc)], map: "idx_entities_last_updated")
  @@index([createdAt(sort: Desc)], map: "idx_entities_created_at")
  @@map("core_entities")
}

model RestaurantLocation {
  locationId          String    @id @default(dbgenerated("gen_random_uuid()")) @map("location_id") @db.Uuid
  restaurantId        String    @map("restaurant_id") @db.Uuid
  googlePlaceId       String?   @unique @map("google_place_id") @db.VarChar(255)
  latitude            Decimal?  @db.Decimal(10, 8)
  longitude           Decimal?  @db.Decimal(11, 8)
  address             String?   @db.VarChar(500)
  city                String?   @db.VarChar(255)
  region              String?   @db.VarChar(255)
  country             String?   @db.VarChar(2)
  postalCode          String?   @map("postal_code") @db.VarChar(32)
  phoneNumber         String?   @map("phone_number") @db.VarChar(64)
  websiteUrl          String?   @map("website_url") @db.VarChar(2048)
  hours               Json?     @map("hours")
  utcOffsetMinutes    Int?      @map("utc_offset_minutes")
  timeZone            String?   @map("time_zone") @db.VarChar(64)
  isPrimary           Boolean   @default(false) @map("is_primary")
  lastPolledAt        DateTime? @map("last_polled_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @default(now()) @map("updated_at")
  restaurant          Entity    @relation("RestaurantLocations", fields: [restaurantId], references: [entityId], onDelete: Cascade)
  primaryFor          Entity?   @relation("PrimaryLocation")

  @@index([restaurantId], map: "idx_restaurant_locations_restaurant")
  @@index([restaurantId, isPrimary], map: "idx_restaurant_locations_primary")
  @@index([longitude, latitude], map: "idx_restaurant_locations_location")
  @@index([googlePlaceId], map: "idx_restaurant_locations_google_place_id")
  @@map("core_restaurant_locations")
}

model Connection {
  connectionId           String        @id @default(dbgenerated("gen_random_uuid()")) @map("connection_id") @db.Uuid
  restaurantId           String        @map("restaurant_id") @db.Uuid
  foodId                 String        @map("food_id") @db.Uuid
  categories             String[]      @default([]) @db.Uuid
  foodAttributes         String[]      @default([]) @map("food_attributes") @db.Uuid
  mentionCount           Int           @default(0) @map("mention_count")
  totalUpvotes           Int           @default(0) @map("total_upvotes")
  recentMentionCount     Int           @default(0) @map("recent_mention_count")
  lastMentionedAt        DateTime?     @map("last_mentioned_at")
  activityLevel          ActivityLevel @default(normal) @map("activity_level")
  foodQualityScore       Decimal       @default(0) @map("food_quality_score") @db.Decimal(10, 4)
  lastUpdated            DateTime      @default(now()) @map("last_updated")
  createdAt              DateTime      @default(now()) @map("created_at")
  decayedMentionScore    Decimal       @default(0) @map("decayed_mention_score") @db.Decimal(18, 6)
  decayedUpvoteScore     Decimal       @default(0) @map("decayed_upvote_score") @db.Decimal(18, 6)
  decayedScoresUpdatedAt DateTime?     @map("decayed_scores_updated_at")
  boostLastAppliedAt     DateTime?     @map("boost_last_applied_at")
  food                   Entity        @relation("FoodEntity", fields: [foodId], references: [entityId])
  restaurant             Entity        @relation("RestaurantEntity", fields: [restaurantId], references: [entityId])
  pollOptions            PollOption[]  @relation("PollOptionConnection")

  @@unique([restaurantId, foodId])
  @@index([restaurantId], map: "idx_connections_restaurant")
  @@index([foodId], map: "idx_connections_food")
  @@index([categories], map: "idx_connections_categories_gin", type: Gin)
  @@index([foodAttributes], map: "idx_connections_attributes_gin", type: Gin)
  @@index([mentionCount(sort: Desc)], map: "idx_connections_mention_count")
  @@index([totalUpvotes(sort: Desc)], map: "idx_connections_total_upvotes")
  @@index([foodQualityScore(sort: Desc)], map: "idx_connections_quality_score")
  @@index([lastMentionedAt(sort: Desc)], map: "idx_connections_last_mentioned")
  @@index([activityLevel], map: "idx_connections_activity")
  @@index([restaurantId, foodQualityScore(sort: Desc)], map: "idx_connections_restaurant_quality")
  @@index([foodId, foodQualityScore(sort: Desc)], map: "idx_connections_food_quality")
  @@index([restaurantId, mentionCount(sort: Desc)], map: "idx_connections_restaurant_mentions")
  @@index([foodId, mentionCount(sort: Desc)], map: "idx_connections_food_mentions")
  @@index([lastUpdated(sort: Desc)], map: "idx_connections_last_updated")
  @@index([createdAt(sort: Desc)], map: "idx_connections_created_at")
  @@index([recentMentionCount(sort: Desc)], map: "idx_connections_recent_mentions")
  @@map("core_connections")
}

model DisplayRankScore {
  locationKey      String                 @map("location_key") @db.VarChar(255)
  subjectType      DisplayRankSubjectType @map("subject_type")
  subjectId        String                 @map("subject_id") @db.Uuid
  rankScoreRaw     Decimal                @map("rank_score_raw") @db.Decimal(9, 4)
  rankScoreDisplay Decimal                @map("rank_score_display") @db.Decimal(5, 1)
  rankPercentile   Decimal                @map("rank_percentile") @db.Decimal(6, 5)
  computedAt       DateTime               @default(now()) @map("computed_at")

  @@id([locationKey, subjectType, subjectId])
  @@index([locationKey, subjectType], map: "idx_display_rank_location_type")
  @@index([subjectType, subjectId], map: "idx_display_rank_subject")
  @@map("core_display_rank_scores")
}

model Boost {
  boostId          String   @id @default(dbgenerated("gen_random_uuid()")) @map("boost_id") @db.Uuid
  restaurantId     String   @map("restaurant_id") @db.Uuid
  categoryId       String   @map("category_id") @db.Uuid
  foodAttributeIds String[] @default([]) @map("food_attribute_ids") @db.Uuid
  mentionCreatedAt DateTime @map("mention_created_at")
  upvotes          Int      @default(0)
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([restaurantId, categoryId, mentionCreatedAt], map: "idx_boosts_restaurant_category_time")
  @@index([categoryId], map: "idx_boosts_category")
  @@index([restaurantId], map: "idx_boosts_restaurant")
  @@index([foodAttributeIds], map: "idx_boosts_food_attributes", type: Gin)
  @@map("core_boosts")
}

model CategoryAggregate {
  restaurantId           String    @map("restaurant_id") @db.Uuid
  categoryId             String    @map("category_id") @db.Uuid
  mentionsCount          Int       @default(0) @map("mentions_count")
  totalUpvotes           Int       @default(0) @map("total_upvotes")
  firstMentionedAt       DateTime  @default(now()) @map("first_mentioned_at")
  lastMentionedAt        DateTime  @map("last_mentioned_at")
  decayedMentionScore    Decimal   @default(0) @map("decayed_mention_score") @db.Decimal(18, 6)
  decayedUpvoteScore     Decimal   @default(0) @map("decayed_upvote_score") @db.Decimal(18, 6)
  decayedScoresUpdatedAt DateTime? @map("decayed_scores_updated_at")

  @@id([restaurantId, categoryId])
  @@index([categoryId], map: "idx_category_aggregate_category")
  @@index([restaurantId, totalUpvotes(sort: Desc)], map: "idx_category_aggregate_restaurant")
  @@map("core_category_aggregates")
}

model PollCategoryAggregate {
  restaurantId   String    @map("restaurant_id") @db.Uuid
  categoryId     String    @map("category_id") @db.Uuid
  pseudoMentions Decimal   @default(0) @map("pseudo_mentions") @db.Decimal(18, 6)
  pseudoUpvotes  Decimal   @default(0) @map("pseudo_upvotes") @db.Decimal(18, 6)
  voteCount      Int       @default(0) @map("vote_count")
  lastVoteAt     DateTime? @map("last_vote_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@id([restaurantId, categoryId])
  @@index([categoryId], map: "idx_poll_category_aggregate_category")
  @@map("poll_category_aggregates")
}

model Source {
  pipeline    String   @db.VarChar(32)
  sourceId    String   @map("source_id") @db.VarChar(64)
  subreddit   String?  @db.VarChar(100)
  processedAt DateTime @default(now()) @map("processed_at")

  @@id([pipeline, sourceId])
  @@index([pipeline], map: "idx_source_pipeline")
  @@index([subreddit], map: "idx_source_subreddit")
  @@index([processedAt(sort: Desc)], map: "idx_source_processed_at")
  @@map("collection_sources")
}

model EntityPriorityMetric {
  entityId               String     @id @map("entity_id") @db.Uuid
  entityType             EntityType @map("entity_type")
  priorityScore          Decimal?   @default(0) @map("priority_score") @db.Decimal(9, 4)
  dataRecencyScore       Decimal?   @default(0) @map("data_recency_score") @db.Decimal(9, 4)
  dataQualityScore       Decimal?   @default(0) @map("data_quality_score") @db.Decimal(9, 4)
  userDemandScore        Decimal?   @default(0) @map("user_demand_score") @db.Decimal(9, 4)
  isNewEntity            Boolean    @default(false) @map("is_new_entity")
  lastCalculatedAt       DateTime   @default(now()) @map("last_calculated_at")
  lastSelectedAt         DateTime?  @map("last_selected_at")
  queryImpressions       Int        @default(0) @map("query_impressions")
  lastQueryAt            DateTime?  @map("last_query_at")
  viewImpressions        Int        @default(0) @map("view_impressions")
  lastViewAt             DateTime?  @map("last_view_at")
  favoriteCount          Int        @default(0) @map("favorite_count")
  autocompleteSelections Int        @default(0) @map("autocomplete_selections")
  entity                 Entity     @relation(fields: [entityId], references: [entityId], onDelete: Cascade)

  @@index([entityType], map: "idx_entity_priority_type")
  @@index([lastCalculatedAt(sort: Desc)], map: "idx_entity_priority_calculated")
  @@map("collection_entity_priority_metrics")
}

model PollTopic {
  topicId            String          @id @default(dbgenerated("gen_random_uuid()")) @map("topic_id") @db.Uuid
  title              String          @db.VarChar(255)
  description        String?         @db.VarChar(500)
  city               String?         @db.VarChar(255)
  region             String?         @db.VarChar(255)
  country            String?         @db.VarChar(2)
  categoryEntityIds  String[]        @default([]) @map("category_entity_ids") @db.Uuid
  seedEntityIds      String[]        @default([]) @map("seed_entity_ids") @db.Uuid
  status             PollTopicStatus @default(draft)
  metadata           Json?           @default("{}")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  targetDishId       String?         @map("target_dish_id") @db.Uuid
  targetRestaurantId String?         @map("target_restaurant_id") @db.Uuid
  topicType          PollTopicType   @default(best_dish) @map("topic_type")
  targetDish         Entity?         @relation("PollTopicTargetDish", fields: [targetDishId], references: [entityId])
  targetRestaurant   Entity?         @relation("PollTopicTargetRestaurant", fields: [targetRestaurantId], references: [entityId])
  polls              Poll[]

  @@index([city], map: "idx_poll_topics_city")
  @@index([status], map: "idx_poll_topics_status")
  @@map("poll_topics")
}

model Poll {
  pollId             String       @id @default(dbgenerated("gen_random_uuid()")) @map("poll_id") @db.Uuid
  topicId            String       @map("topic_id") @db.Uuid
  question           String       @db.VarChar(500)
  state              PollState    @default(draft)
  city               String?      @db.VarChar(255)
  region             String?      @db.VarChar(255)
  scheduledFor       DateTime?    @map("scheduled_for")
  launchedAt         DateTime?    @map("launched_at")
  closedAt           DateTime?    @map("closed_at")
  allowUserAdditions Boolean      @default(true) @map("allow_user_additions")
  audienceFilters    Json?        @map("audience_filters")
  metadata           Json?        @default("{}")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  metrics            PollMetric?
  options            PollOption[]
  votes              PollVote[]
  topic              PollTopic    @relation(fields: [topicId], references: [topicId], onDelete: Cascade)

  @@index([topicId], map: "idx_polls_topic_id")
  @@index([state], map: "idx_polls_state")
  @@index([city], map: "idx_polls_city")
  @@index([scheduledFor], map: "idx_polls_scheduled_for")
  @@map("polls")
}

model PollOption {
  optionId            String                     @id @default(dbgenerated("gen_random_uuid()")) @map("option_id") @db.Uuid
  pollId              String                     @map("poll_id") @db.Uuid
  entityId            String?                    @map("entity_id") @db.Uuid
  label               String                     @db.VarChar(255)
  source              PollOptionSource           @default(user)
  resolutionStatus    PollOptionResolutionStatus @default(pending) @map("resolution_status")
  addedByUserId       String?                    @map("added_by_user_id") @db.Uuid
  voteCount           Int                        @default(0) @map("vote_count")
  aggregatedVoteCount Int                        @default(0) @map("aggregated_vote_count")
  consensus           Decimal?                   @default(0) @db.Decimal(7, 4)
  lastVoteAt          DateTime?                  @map("last_vote_at")
  metadata            Json?                      @default("{}")
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")
  categoryId          String?                    @map("category_id") @db.Uuid
  connectionId        String?                    @map("connection_id") @db.Uuid
  foodId              String?                    @map("food_id") @db.Uuid
  restaurantId        String?                    @map("restaurant_id") @db.Uuid
  category            Entity?                    @relation("PollOptionCategoryEntity", fields: [categoryId], references: [entityId])
  connection          Connection?                @relation("PollOptionConnection", fields: [connectionId], references: [connectionId])
  entity              Entity?                    @relation("PollOptionPrimaryEntity", fields: [entityId], references: [entityId])
  food                Entity?                    @relation("PollOptionFoodEntity", fields: [foodId], references: [entityId])
  poll                Poll                       @relation(fields: [pollId], references: [pollId], onDelete: Cascade)
  restaurant          Entity?                    @relation("PollOptionRestaurantEntity", fields: [restaurantId], references: [entityId])
  votes               PollVote[]

  @@index([pollId], map: "idx_poll_options_poll_id")
  @@index([entityId], map: "idx_poll_options_entity_id")
  @@index([restaurantId], map: "idx_poll_options_restaurant_id")
  @@index([foodId], map: "idx_poll_options_food_id")
  @@index([connectionId], map: "idx_poll_options_connection_id")
  @@index([categoryId], map: "idx_poll_options_category_id")
  @@map("poll_options")
}

model PollVote {
  pollId    String     @map("poll_id") @db.Uuid
  optionId  String     @map("option_id") @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  weight    Int        @default(1)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  option    PollOption @relation(fields: [optionId], references: [optionId], onDelete: Cascade)
  poll      Poll       @relation(fields: [pollId], references: [pollId], onDelete: Cascade)

  @@id([optionId, userId])
  @@index([optionId], map: "idx_poll_votes_option_id")
  @@index([pollId, userId], map: "idx_poll_votes_poll_user")
  @@index([pollId], map: "idx_poll_votes_poll_id")
  @@map("poll_votes")
}

model PollMetric {
  pollId            String    @id @map("poll_id") @db.Uuid
  totalVotes        Int       @default(0) @map("total_votes")
  totalParticipants Int       @default(0) @map("total_participants")
  lastAggregatedAt  DateTime? @map("last_aggregated_at")
  metadata          Json?     @default("{}")
  poll              Poll      @relation(fields: [pollId], references: [pollId], onDelete: Cascade)

  @@map("poll_metrics")
}

model NotificationDevice {
  deviceId      String               @id @default(dbgenerated("gen_random_uuid()")) @map("device_id") @db.Uuid
  userId        String?              @map("user_id") @db.VarChar(255)
  expoPushToken String               @unique @map("expo_push_token") @db.VarChar(255)
  provider      NotificationProvider @default(expo)
  platform      String?              @db.VarChar(50)
  appVersion    String?              @map("app_version") @db.VarChar(32)
  locale        String?              @db.VarChar(16)
  city          String?              @db.VarChar(255)
  metadata      Json?                @default("{}")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  notifications Notification[]

  @@index([userId], map: "idx_notification_devices_user_id")
  @@index([city], map: "idx_notification_devices_city")
  @@map("notification_devices")
}

model Notification {
  notificationId String              @id @default(dbgenerated("gen_random_uuid()")) @map("notification_id") @db.Uuid
  type           NotificationType    @map("notification_type")
  status         NotificationStatus  @default(pending) @map("status")
  payload        Json?               @default("{}")
  scheduledFor   DateTime?           @map("scheduled_for")
  sentAt         DateTime?           @map("sent_at")
  attempts       Int                 @default(0)
  lastError      String?             @map("last_error") @db.VarChar(500)
  deviceId       String?             @map("device_id") @db.Uuid
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  device         NotificationDevice? @relation(fields: [deviceId], references: [deviceId])

  @@index([status], map: "idx_notifications_status")
  @@index([scheduledFor], map: "idx_notifications_scheduled_for")
  @@index([deviceId], map: "idx_notifications_device_id")
  @@map("notifications")
}

model SearchLog {
  logId                  String          @id @default(dbgenerated("gen_random_uuid()")) @map("log_id") @db.Uuid
  entityId               String          @map("entity_id") @db.Uuid
  entityType             EntityType      @map("entity_type")
  userId                 String?         @map("user_id") @db.Uuid
  locationKey            String?         @map("location_key") @db.VarChar(255)
  queryText              String?         @map("query_text") @db.VarChar(500)
  searchRequestId        String?         @map("search_request_id") @db.Uuid
  totalResults           Int?            @map("total_results")
  totalFoodResults       Int?            @map("total_food_results")
  totalRestaurantResults Int?            @map("total_restaurant_results")
  queryExecutionTimeMs   Int?            @map("query_execution_time_ms")
  coverageStatus         String?         @map("coverage_status") @db.VarChar(32)
  source                 SearchLogSource @default(search)
  metadata               Json?           @default("{}")
  loggedAt               DateTime        @default(now()) @map("logged_at")
  entity                 Entity          @relation(fields: [entityId], references: [entityId], onDelete: Cascade)
  user                   User?           @relation(fields: [userId], references: [userId], onDelete: SetNull)

  @@unique([searchRequestId, entityId], map: "uq_search_log_request_entity")
  @@index([entityId], map: "idx_search_log_entity")
  @@index([locationKey], map: "idx_search_log_location")
  @@index([loggedAt(sort: Desc)], map: "idx_search_log_logged_at")
  @@index([entityId, locationKey, loggedAt], map: "idx_search_log_entity_location_time")
  @@index([userId], map: "idx_search_log_user_id")
  @@index([userId, searchRequestId], map: "idx_search_log_user_request")
  @@index([userId, queryText], map: "idx_search_log_user_query")
  @@index([queryText], map: "idx_search_log_query_text")
  @@map("user_search_logs")
}

model RestaurantView {
  userId       String   @map("user_id") @db.Uuid
  restaurantId String   @map("restaurant_id") @db.Uuid
  lastViewedAt DateTime @default(now()) @map("last_viewed_at")
  viewCount    Int      @default(1) @map("view_count")
  metadata     Json?    @default("{}")
  user         User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  restaurant   Entity   @relation(fields: [restaurantId], references: [entityId], onDelete: Cascade)

  @@id([userId, restaurantId])
  @@index([userId, lastViewedAt(sort: Desc)], map: "idx_restaurant_views_user_time")
  @@index([restaurantId], map: "idx_restaurant_views_restaurant")
  @@map("user_restaurant_views")
}

model UserFavorite {
  favoriteId String     @id @default(dbgenerated("gen_random_uuid()")) @map("favorite_id") @db.Uuid
  userId     String     @map("user_id") @db.Uuid
  entityId   String     @map("entity_id") @db.Uuid
  entityType EntityType @map("entity_type")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  user       User       @relation(fields: [userId], references: [userId], onDelete: Cascade)
  entity     Entity     @relation(fields: [entityId], references: [entityId], onDelete: Cascade)

  @@unique([userId, entityId], map: "user_favorites_user_entity_unique")
  @@index([userId], map: "idx_user_favorites_user")
  @@map("user_favorites")
}

model User {
  userId              String             @id @default(dbgenerated("gen_random_uuid()")) @map("user_id") @db.Uuid
  email               String             @unique @db.VarChar(255)
  createdAt           DateTime           @default(now()) @map("created_at")
  trialStartedAt      DateTime?          @map("trial_started_at")
  trialEndsAt         DateTime?          @map("trial_ends_at")
  subscriptionStatus  SubscriptionStatus @default(trialing) @map("subscription_status")
  stripeCustomerId    String?            @map("stripe_customer_id") @db.VarChar(255)
  referralCode        String?            @unique @map("referral_code") @db.VarChar(50)
  referredBy          String?            @map("referred_by") @db.Uuid
  authProvider        AuthProvider       @default(clerk) @map("auth_provider")
  authProviderUserId  String?            @unique @map("auth_provider_user_id") @db.VarChar(255)
  deletedAt           DateTime?          @map("deleted_at")
  lastSignInAt        DateTime?          @map("last_sign_in_at")
  revenueCatAppUserId String?            @unique @map("revenuecat_app_user_id") @db.VarChar(255)
  updatedAt           DateTime           @updatedAt @map("updated_at")
  checkoutSessions    CheckoutSession[]
  subscriptions       Subscription[]
  entitlements        UserEntitlement[]
  events              UserEvent[]
  favorites           UserFavorite[]
  searchLogs          SearchLog[]
  restaurantViews     RestaurantView[]
  referrer            User?              @relation("UserReferrals", fields: [referredBy], references: [userId])
  referrals           User[]             @relation("UserReferrals")

  @@index([email], map: "idx_users_email")
  @@index([authProvider], map: "idx_users_auth_provider")
  @@index([authProviderUserId], map: "idx_users_auth_provider_user_id")
  @@index([revenueCatAppUserId], map: "idx_users_revenuecat_app_user_id")
  @@index([subscriptionStatus], map: "idx_users_subscription_status")
  @@index([createdAt(sort: Desc)], map: "idx_users_created_at")
  @@index([trialEndsAt], map: "idx_users_trial_ends_at")
  @@index([referralCode], map: "idx_users_referral_code")
  @@index([referredBy], map: "idx_users_referred_by")
  @@map("users")
}

model Subscription {
  subscriptionId         String                @id @default(dbgenerated("gen_random_uuid()")) @map("subscription_id") @db.Uuid
  userId                 String                @map("user_id") @db.Uuid
  status                 SubscriptionStatus
  currentPeriodStart     DateTime?             @map("current_period_start")
  currentPeriodEnd       DateTime?             @map("current_period_end")
  cancelAtPeriodEnd      Boolean               @default(false) @map("cancel_at_period_end")
  cancelledAt            DateTime?             @map("cancelled_at")
  createdAt              DateTime              @default(now()) @map("created_at")
  entitlementCode        String?               @map("entitlement_code") @db.VarChar(255)
  externalCustomerId     String?               @map("external_customer_id") @db.VarChar(255)
  externalSubscriptionId String?               @map("external_subscription_id") @db.VarChar(255)
  lastEventId            String?               @map("last_event_id") @db.VarChar(255)
  lastEventReceivedAt    DateTime?             @map("last_event_received_at")
  metadata               Json?                 @default("{}")
  planName               String?               @map("plan_name") @db.VarChar(255)
  platform               SubscriptionPlatform? @map("platform")
  priceId                String?               @map("price_id") @db.VarChar(255)
  productId              String?               @map("product_id") @db.VarChar(255)
  provider               SubscriptionProvider  @map("provider")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  user                   User                  @relation(fields: [userId], references: [userId])

  @@unique([provider, externalSubscriptionId], map: "subscriptions_provider_external_unique")
  @@index([userId], map: "idx_subscriptions_user_id")
  @@index([status], map: "idx_subscriptions_status")
  @@index([currentPeriodEnd], map: "idx_subscriptions_period_end")
  @@index([provider], map: "idx_subscriptions_provider")
  @@index([provider, externalSubscriptionId], map: "idx_subscriptions_provider_external_id")
  @@index([provider, externalCustomerId], map: "idx_subscriptions_provider_customer_id")
  @@index([entitlementCode], map: "idx_subscriptions_entitlement_code")
  @@index([createdAt(sort: Desc)], map: "idx_subscriptions_created_at")
  @@map("billing_subscriptions")
}

model UserEntitlement {
  entitlementId     String                @id @default(dbgenerated("gen_random_uuid()")) @map("entitlement_id") @db.Uuid
  userId            String                @map("user_id") @db.Uuid
  entitlementCode   String                @map("entitlement_code") @db.VarChar(255)
  source            SubscriptionProvider  @map("source")
  platform          SubscriptionPlatform? @map("platform")
  status            EntitlementStatus     @default(active)
  isGracePeriod     Boolean               @default(false) @map("is_grace_period")
  activatedAt       DateTime              @default(now()) @map("activated_at")
  expiresAt         DateTime?             @map("expires_at")
  gracePeriodEndsAt DateTime?             @map("grace_period_ends_at")
  lastEventId       String?               @map("last_event_id") @db.VarChar(255)
  lastSyncedAt      DateTime?             @map("last_synced_at")
  metadata          Json?                 @default("{}")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  user              User                  @relation(fields: [userId], references: [userId])

  @@unique([userId, entitlementCode], map: "user_entitlements_user_code_key")
  @@index([userId], map: "idx_user_entitlements_user_id")
  @@index([entitlementCode], map: "idx_user_entitlements_code")
  @@index([status], map: "idx_user_entitlements_status")
  @@map("billing_entitlements")
}

model BillingEventLog {
  eventLogId      String                @id @default(dbgenerated("gen_random_uuid()")) @map("event_log_id") @db.Uuid
  source          SubscriptionProvider  @map("source")
  platform        SubscriptionPlatform? @map("platform")
  externalEventId String                @map("external_event_id") @db.VarChar(255)
  eventType       String                @map("event_type") @db.VarChar(255)
  status          BillingEventStatus    @default(received)
  payload         Json                  @default("{}")
  receivedAt      DateTime              @default(now()) @map("received_at")
  processedAt     DateTime?             @map("processed_at")
  errorMessage    String?               @map("error_message")
  retryCount      Int                   @default(0) @map("retry_count")
  correlationId   String?               @map("correlation_id") @db.VarChar(255)
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  @@unique([source, externalEventId], map: "billing_event_unique_external")
  @@index([status], map: "idx_billing_event_status")
  @@index([receivedAt(sort: Desc)], map: "idx_billing_event_received_at")
  @@map("billing_event_logs")
}

model CheckoutSession {
  checkoutSessionId String                @id @default(dbgenerated("gen_random_uuid()")) @map("checkout_session_id") @db.Uuid
  userId            String                @map("user_id") @db.Uuid
  provider          SubscriptionProvider  @map("provider")
  externalSessionId String?               @map("external_session_id") @db.VarChar(255)
  status            CheckoutSessionStatus @default(pending)
  url               String?               @db.VarChar(2048)
  cancelUrl         String?               @map("cancel_url") @db.VarChar(2048)
  successUrl        String?               @map("success_url") @db.VarChar(2048)
  expiresAt         DateTime?             @map("expires_at")
  completedAt       DateTime?             @map("completed_at")
  cancelledAt       DateTime?             @map("cancelled_at")
  metadata          Json?                 @default("{}")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  user              User                  @relation(fields: [userId], references: [userId])

  @@index([userId], map: "idx_checkout_sessions_user_id")
  @@index([provider], map: "idx_checkout_sessions_provider")
  @@index([status], map: "idx_checkout_sessions_status")
  @@index([externalSessionId], map: "idx_checkout_sessions_external_id")
  @@map("billing_checkout_sessions")
}

model UserEvent {
  eventId   String   @id @default(dbgenerated("gen_random_uuid()")) @map("event_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  eventType String   @map("event_type") @db.VarChar(50)
  eventData Json     @default("{}") @map("event_data")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [userId])

  @@index([userId], map: "idx_user_events_user_id")
  @@index([eventType], map: "idx_user_events_event_type")
  @@index([createdAt(sort: Desc)], map: "idx_user_events_created_at")
  @@index([userId, eventType], map: "idx_user_events_user_type")
  @@index([userId, createdAt(sort: Desc)], map: "idx_user_events_user_created")
  @@map("user_events")
}

model Subreddit {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String    @unique @db.Citext
  locationName     String?   @map("location_name") @db.Citext
  coverageKey      String?   @map("coverage_key") @db.VarChar(100)
  avgPostsPerDay   Float?    @map("avg_posts_per_day")
  lastCalculated   DateTime? @map("last_calculated") @db.Timestamptz(6)
  lastProcessed    DateTime? @map("last_processed") @db.Timestamptz(6)
  isActive         Boolean   @default(true) @map("is_active")
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  safeIntervalDays Float?    @map("safe_interval_days")
  centerLatitude   Decimal?  @map("center_latitude") @db.Decimal(11, 8)
  centerLongitude  Decimal?  @map("center_longitude") @db.Decimal(11, 8)
  viewportNeLat    Decimal?  @map("viewport_ne_latitude") @db.Decimal(11, 8)
  viewportNeLng    Decimal?  @map("viewport_ne_longitude") @db.Decimal(11, 8)
  viewportSwLat    Decimal?  @map("viewport_sw_latitude") @db.Decimal(11, 8)
  viewportSwLng    Decimal?  @map("viewport_sw_longitude") @db.Decimal(11, 8)

  @@index([name])
  @@index([coverageKey], map: "idx_collection_subreddits_coverage_key")
  @@index([isActive])
  @@index([lastProcessed])
  @@index([safeIntervalDays])
  @@map("collection_subreddits")
}

model OnDemandRequest {
  requestId             String           @id @default(dbgenerated("gen_random_uuid()")) @map("request_id") @db.Uuid
  term                  String           @db.VarChar(255)
  entityType            EntityType       @map("entity_type")
  locationKey           String           @default("global") @map("location_key") @db.VarChar(255)
  occurrenceCount       Int              @default(1) @map("occurrence_count")
  lastSeenAt            DateTime         @default(now()) @map("last_seen_at")
  metadata              Json?            @default("{}")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  status                OnDemandStatus   @default(pending)
  entityId              String?          @map("entity_id") @db.Uuid
  lastEnqueuedAt        DateTime?        @map("last_enqueued_at")
  reason                OnDemandReason
  resultRestaurantCount Int              @default(0) @map("result_restaurant_count")
  resultFoodCount       Int              @default(0) @map("result_food_count")
  attemptedSubreddits   String[]         @default([]) @map("attempted_subreddits")
  deferredAttempts      Int              @default(0) @map("deferred_attempts")
  lastOutcome           OnDemandOutcome? @map("last_outcome")
  lastAttemptAt         DateTime?        @map("last_attempt_at")
  lastCompletedAt       DateTime?        @map("last_completed_at")
  entity                Entity?          @relation(fields: [entityId], references: [entityId])

  @@unique([term, entityType, reason, locationKey])
  @@map("collection_on_demand_requests")
}

enum OnDemandStatus {
  pending
  queued
  processing
  completed
}

enum OnDemandOutcome {
  success
  no_results
  error
  deferred
  no_active_subreddits
}

enum OnDemandReason {
  low_result
  unresolved
}

enum EntityType {
  restaurant
  food
  food_attribute
  restaurant_attribute

  @@map("entity_type")
}

enum DisplayRankSubjectType {
  restaurant
  connection

  @@map("display_rank_subject_type")
}

enum PollTopicStatus {
  draft
  ready
  archived

  @@map("poll_topic_status")
}

enum PollTopicType {
  best_dish
  what_to_order

  @@map("poll_topic_type")
}

enum PollState {
  draft
  scheduled
  active
  closed
  archived

  @@map("poll_state")
}

enum PollOptionSource {
  user
  seed
  curator

  @@map("poll_option_source")
}

enum PollOptionResolutionStatus {
  pending
  matched
  rejected

  @@map("poll_option_resolution_status")
}

enum NotificationStatus {
  pending
  scheduled
  sending
  sent
  failed

  @@map("notification_status")
}

enum NotificationType {
  poll_release

  @@map("notification_type")
}

enum NotificationProvider {
  expo

  @@map("notification_provider")
}

enum ActivityLevel {
  trending
  active
  normal

  @@map("activity_level")
}

enum SubscriptionStatus {
  trialing
  active
  cancelled
  expired

  @@map("subscription_status")
}

enum SubscriptionProvider {
  stripe
  revenuecat
  manual

  @@map("subscription_provider")
}

enum SubscriptionPlatform {
  web
  ios
  android

  @@map("subscription_platform")
}

enum EntitlementStatus {
  active
  inactive
  expired
  revoked

  @@map("entitlement_status")
}

enum BillingEventStatus {
  received
  processing
  processed
  failed

  @@map("billing_event_status")
}

enum CheckoutSessionStatus {
  pending
  open
  completed
  expired
  cancelled

  @@map("checkout_session_status")
}

enum AuthProvider {
  clerk
  supabase
  magic_link

  @@map("auth_provider")
}

enum MentionSource {
  post
  comment

  @@map("mention_source")
}

enum SearchLogSource {
  search
  poll

  @@map("search_log_source")
}
