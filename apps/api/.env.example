# =============================================================================
# =============================================================================
#
#   ğŸš€ CRAVE API - PRODUCTION READINESS SETUP GUIDE
#
#   Last Updated: January 2026
#   Session Context: Production-readiness implementation
#
# =============================================================================
# =============================================================================
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸ“‹ WHAT WAS ADDED IN THIS SESSION                                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   1. HEALTH CHECK MODULE (apps/api/src/modules/health/)
#      - GET /health        â†’ Full health check (DB + Redis)
#      - GET /health/live   â†’ Liveness probe (always returns 200 if server up)
#      - GET /health/ready  â†’ Readiness probe (checks DB + Redis)
#      Purpose: Railway uses these to know when your container is healthy
#
#   2. SENTRY ERROR TRACKING (apps/api/src/sentry/)
#      - SentryFilter: Captures all 5xx errors automatically
#      - SentryInterceptor: Performance monitoring for all requests
#      - Configured in main.ts (MUST be first import)
#      Purpose: See all production errors with full stack traces + context
#
#   3. RATE LIMITING (apps/api/src/modules/infrastructure/throttler/)
#      - Redis-backed distributed rate limiting
#      - 3 tiers: short (5/1s), medium (30/10s), long (100/60s)
#      - Decorators: @ShortRateLimit, @MediumRateLimit, @LongRateLimit
#      Purpose: Protect against abuse, DDoS, runaway clients
#
#   4. DEBUG MODULE (apps/api/src/modules/debug/)
#      - GET  /api/debug/sentry-test       â†’ Throws test error for Sentry
#      - POST /api/debug/sentry-message    â†’ Sends test message to Sentry
#      - GET  /api/debug/sentry-async-error â†’ Tests async error capture
#      Purpose: Verify Sentry integration is working
#      âš ï¸  DISABLE THIS MODULE IN PRODUCTION (remove from app.module.ts)
#
#   5. PRODUCTION DOCKERFILE (apps/api/Dockerfile)
#      - Multi-stage build for optimized image size
#      - Runs as non-root user (security best practice)
#      - Includes health check endpoint
#      Purpose: Deploy to Railway with optimized container
#
#   6. GRACEFUL SHUTDOWN (apps/api/src/main.ts)
#      - enableShutdownHooks() for clean deployments
#      - Unhandled error handlers with Sentry integration
#      Purpose: No dropped requests during Railway deployments
#
#   7. CI/CD FIX (.github/workflows/ci.yml)
#      - Fixed: Was using PNPM, switched to Yarn (your actual package manager)
#      - Added: Lint and type-check steps before build
#      Purpose: Catch errors before merging to main
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  âœ… SETUP CHECKLIST - COMPLETE THESE ON YOUR MAC                           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   [ ] 1. MERGE ENV VARIABLES
#          Your Mac has a more complete .env file. Add these NEW variables to it:
#          - SENTRY_DSN (copy from line ~573 below)
#          - SENTRY_ENVIRONMENT=development
#          - SENTRY_TRACES_SAMPLE_RATE=1.0
#          - SENTRY_PROFILES_SAMPLE_RATE=1.0
#          - THROTTLER_SHORT_TTL=1000
#          - THROTTLER_SHORT_LIMIT=5
#          - THROTTLER_MEDIUM_TTL=10000
#          - THROTTLER_MEDIUM_LIMIT=30
#          - THROTTLER_LONG_TTL=60000
#          - THROTTLER_LONG_LIMIT=100
#
#   [ ] 2. INSTALL NEW DEPENDENCIES
#          cd apps/api && yarn install
#          New packages: @sentry/nestjs, @sentry/profiling-node
#
#   [ ] 3. START SERVICES & TEST LOCALLY
#          docker-compose up -d          # Start PostgreSQL + Redis
#          yarn workspace api start:dev  # Start API
#
#   [ ] 4. TEST HEALTH ENDPOINT
#          curl http://localhost:3000/health
#          Expected: {"status":"healthy","checks":{"database":"healthy","redis":"healthy"}}
#
#   [ ] 5. TEST LEGAL ENDPOINTS (required for App Store submission)
#          curl http://localhost:3000/privacy  # Should return HTML privacy policy
#          curl http://localhost:3000/terms    # Should return HTML terms of service
#          Open in browser to verify formatting looks good
#
#   [ ] 6. CUSTOMIZE LEGAL DOCUMENTS (IMPORTANT!)
#          Edit apps/api/src/modules/legal/legal.controller.ts:
#          - Replace "privacy@cravesearch.com" with your actual email
#          - Replace "support@cravesearch.com" with your actual email
#          - Replace "[Your State/Country]" with your jurisdiction (e.g., "California" or "Delaware")
#          - Replace "[Your Jurisdiction]" with where disputes will be handled
#          - Review all content to ensure it matches your actual practices
#
#   [ ] 7. UPDATE MOBILE APP FOR API VERSIONING (BREAKING CHANGE!)
#          âš ï¸ ALL API calls must now use /api/v1/ prefix instead of /api/
#          
#          Search your mobile codebase for API calls and update:
#          OLD: const API_BASE = 'https://api.crave.com/api'
#          NEW: const API_BASE = 'https://api.crave.com/api/v1'
#          
#          Or update individual endpoints:
#          OLD: fetch('/api/search')
#          NEW: fetch('/api/v1/search')
#          
#          Excluded routes (no version prefix needed):
#          - /health, /health/live, /health/ready
#          - /privacy, /terms
#          - /metrics
#
#   [ ] 8. TEST SENTRY INTEGRATION (if you uncomment DebugModule for testing)
#          curl http://localhost:3000/api/v1/debug/sentry-test
#          Check Sentry dashboard for the error within ~10 seconds
#          Remember to re-comment DebugModule after testing!
#
#   [ ] 9. RUN LINTING (REQUIRED before committing)
#          yarn workspace api lint
#          Must have ZERO errors, especially no-unsafe-* warnings
#          Fix any issues before proceeding
#
#   [ ] 10. SETUP SENTRY ALERTS (see detailed guide below)
#           This is critical - without alerts, you won't know about production errors!
#
#   [ ] 11. TEST DOCKERFILE LOCALLY (optional but recommended)
#           cd apps/api
#           docker build -t crave-api:test .
#           docker run -p 3000:3000 --env-file .env crave-api:test
#           curl http://localhost:3000/health
#
#   [ ] 12. DEPLOY TO RAILWAY (see detailed guide below)
#           Follow the complete Railway setup process
#           Remember to run migrations BEFORE deploying code
#
#   [ ] 13. UPDATE APP STORE LISTINGS
#           Apple App Store Connect:
#           - Privacy Policy URL: https://your-railway-domain.up.railway.app/privacy
#           
#           Google Play Console:
#           - Privacy Policy URL: https://your-railway-domain.up.railway.app/privacy
#           - Terms & Conditions URL: https://your-railway-domain.up.railway.app/terms
#
#   [ ] 14. COPY UPDATED .ENV BACK TO .ENV.EXAMPLE
#           After everything works on your Mac:
#           - Copy your complete .env file to .env.example
#           - Remove ALL secret values (API keys, passwords, etc.)
#           - Leave the structure and variable names
#           - Commit the updated .env.example to Git
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸ”” SENTRY ALERT CONFIGURATION GUIDE                                       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   Your current alert setup has some issues. Here's the recommended approach:
#
#   PROBLEM WITH CURRENT SETUP:
#   - Using "all" filter means ALL conditions must match (too restrictive)
#   - Having multiple "users affected" conditions with "all" is redundant
#   - 10 occurrences minimum is too high to catch issues early
#   - One alert trying to do everything = alert fatigue or missed issues
#
#   RECOMMENDED: CREATE 3 SEPARATE ALERTS
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ ALERT 1: "New Issue Alert" (Catch new bugs immediately)                â”‚
#   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#   â”‚ Environment: All Environments                                          â”‚
#   â”‚ Project: crave-api (make sure this is your NestJS project!)            â”‚
#   â”‚                                                                         â”‚
#   â”‚ WHEN: A new issue is created                                            â”‚
#   â”‚                                                                         â”‚
#   â”‚ IF: The issue's level is equal to "error" or "fatal"                    â”‚
#   â”‚                                                                         â”‚
#   â”‚ THEN: Send Discord notification                                         â”‚
#   â”‚       Tags to show: environment, url, user.email                        â”‚
#   â”‚                                                                         â”‚
#   â”‚ Interval: 1 hour (prevents spam for same issue)                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ ALERT 2: "Error Spike Alert" (Catch when things go wrong fast)         â”‚
#   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#   â”‚ Environment: production                                                 â”‚
#   â”‚ Project: crave-api                                                      â”‚
#   â”‚                                                                         â”‚
#   â”‚ WHEN: Number of events in an issue is more than 50 in 1 hour            â”‚
#   â”‚                                                                         â”‚
#   â”‚ IF: (no additional filters)                                             â”‚
#   â”‚                                                                         â”‚
#   â”‚ THEN: Send Discord notification                                         â”‚
#   â”‚       Tags to show: environment, url, browser                           â”‚
#   â”‚                                                                         â”‚
#   â”‚ Interval: 1 hour                                                        â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ ALERT 3: "User Impact Alert" (Catch widespread issues)                 â”‚
#   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#   â”‚ Environment: production                                                 â”‚
#   â”‚ Project: crave-api                                                      â”‚
#   â”‚                                                                         â”‚
#   â”‚ WHEN: Number of users affected by an issue is more than 10 in 1 hour    â”‚
#   â”‚                                                                         â”‚
#   â”‚ IF: (no additional filters)                                             â”‚
#   â”‚                                                                         â”‚
#   â”‚ THEN: Send Discord notification                                         â”‚
#   â”‚       Tags to show: environment, user.email, url                        â”‚
#   â”‚                                                                         â”‚
#   â”‚ Interval: 30 minutes                                                    â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   WHY THIS IS BETTER:
#   âœ“ Alert 1: Catches new bugs immediately (you want to know ASAP)
#   âœ“ Alert 2: Catches volume spikes (something broke badly)
#   âœ“ Alert 3: Catches user impact (many users hitting same bug)
#   âœ“ Each alert has ONE job = easier to tune, less noise
#   âœ“ Lower thresholds catch issues before they become critical
#
#   DISCORD CHANNEL ID (not URL):
#   - Right-click your Discord channel â†’ "Copy Channel ID"
#   - Enable Developer Mode: User Settings â†’ App Settings â†’ Advanced â†’ Developer Mode
#   - The ID looks like: 1234567890123456789 (just numbers)
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸš‚ RAILWAY DEPLOYMENT GUIDE                                               â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   ğŸ“– FULL GUIDE: See /RAILWAY.md for complete deployment reference
#
#   MIGRATION STRATEGY: Option B - Manual Railway CLI (chosen)
#   - Safe, explicit control over migrations
#   - Run migrations BEFORE deploying code
#   - Easy rollback if issues occur
#
#   Railway was chosen because:
#   - Hosts NestJS + PostgreSQL + Redis in one place
#   - Easy GitHub integration with auto-deploy
#   - Generous free tier ($5/month credit)
#   - Simple environment variable management
#   - Built-in health checks
#
#   STEP-BY-STEP DEPLOYMENT:
#
#   1. CREATE RAILWAY ACCOUNT
#      - Go to https://railway.app
#      - Sign up with GitHub (recommended)
#
#   2. CREATE NEW PROJECT
#      - Click "New Project" â†’ "Deploy from GitHub Repo"
#      - Select your Crave repository
#      - Railway will detect it's a monorepo
#
#   3. ADD POSTGRESQL
#      - Click "+ New" â†’ "Database" â†’ "Add PostgreSQL"
#      - Railway auto-creates DATABASE_URL variable
#      - Note: This is a managed PostgreSQL instance
#
#   4. ADD REDIS
#      - Click "+ New" â†’ "Database" â†’ "Add Redis"
#      - Railway auto-creates REDIS_URL variable
#
#   5. CONFIGURE API SERVICE
#      Railway should auto-detect railway.json, but verify:
#
#      Settings â†’ Build:
#        Builder: Dockerfile
#        Dockerfile Path: apps/api/Dockerfile
#
#      Settings â†’ Deploy:
#        Health Check Path: /health
#        Health Check Timeout: 100s
#        Restart Policy: On Failure (max 10 retries)
#
#   6. SET ENVIRONMENT VARIABLES
#      Go to Variables tab and add:
#
#      # Railway provides these automatically (use variable references):
#      DATABASE_URL=${{Postgres.DATABASE_URL}}
#      REDIS_URL=${{Redis.REDIS_URL}}
#
#      # Parse REDIS_URL into individual variables (add this to Railway):
#      REDIS_HOST=${{Redis.REDIS_HOST}}
#      REDIS_PORT=${{Redis.REDIS_PORT}}
#
#      # You need to set these manually:
#      NODE_ENV=production
#      APP_ENV=prod
#      PORT=3000
#
#      # Sentry (use lower sample rates in production!)
#      SENTRY_DSN=https://b481c1ffbec1d8acf87d7fb750d78cbc@o4510664962211840.ingest.us.sentry.io/4510664990523392
#      SENTRY_ENVIRONMENT=production
#      SENTRY_TRACES_SAMPLE_RATE=0.1
#      SENTRY_PROFILES_SAMPLE_RATE=0.1
#
#      # Rate limiting (production should be stricter than dev)
#      THROTTLER_SHORT_LIMIT=3
#      THROTTLER_MEDIUM_LIMIT=20
#      THROTTLER_LONG_LIMIT=60
#
#      # Copy all other API keys from your .env file:
#      # - CLERK_SECRET_KEY
#      # - LLM_API_KEY_PROD
#      # - GOOGLE_PLACES_API_KEY_PROD
#      # - STRIPE_* variables
#      # - etc.
#
#   7. INSTALL RAILWAY CLI (one-time setup)
#      macOS/Linux:
#        brew install railway
#        # or
#        npm i -g @railway/cli
#
#      Windows:
#        npm i -g @railway/cli
#
#      Login:
#        railway login
#        railway link  # Link to your Railway project
#
#   8. DEPLOY & MIGRATE WORKFLOW (use this process for every deployment)
#
#      Step 1: Run migrations FIRST (before deploying code)
#        railway run yarn workspace api db:migrate:deploy
#
#        This runs Prisma migrations in production database safely.
#        If migration fails, your current production app keeps running.
#
#      Step 2: Deploy your code
#        git push origin main
#        # Railway auto-deploys after migrations are complete
#
#      Why this order?
#      âœ“ Migrations run before new code deploys
#      âœ“ If migration fails, deployment doesn't happen
#      âœ“ No downtime if migration has issues
#      âœ“ Can rollback easily
#
#      FIRST DEPLOYMENT ONLY:
#      - Run migrations to initialize database schema
#      - After that, only run when you have new migrations
#
#   9. VERIFY DEPLOYMENT
#      Check health:
#        curl https://your-app.up.railway.app/health
#
#      Check logs:
#        railway logs
#
#   10. GET YOUR PUBLIC URL
#       - Railway provides: https://crave-api-production.up.railway.app
#       - Add custom domain in Settings â†’ Domains
#
#   COST ESTIMATE:
#   - Hobby Plan: $5 free credit/month (good for testing)
#   - Pro Plan: $20/month (recommended for production)
#     - Better resource limits
#     - Team features
#     - Priority support
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸ“ FILES CREATED/MODIFIED IN THIS SESSION                                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   NEW FILES - MODULES:
#   - apps/api/src/modules/health/health.service.ts
#   - apps/api/src/modules/health/health.controller.ts
#   - apps/api/src/modules/health/health.module.ts
#   - apps/api/src/modules/health/index.ts
#   - apps/api/src/sentry/sentry.filter.ts
#   - apps/api/src/sentry/sentry.interceptor.ts
#   - apps/api/src/sentry/sentry.module.ts
#   - apps/api/src/sentry/index.ts
#   - apps/api/src/modules/infrastructure/throttler/throttler-redis.storage.ts
#   - apps/api/src/modules/infrastructure/throttler/throttler.decorator.ts
#   - apps/api/src/modules/infrastructure/throttler/throttler.module.ts
#   - apps/api/src/modules/infrastructure/throttler/index.ts
#   - apps/api/src/modules/infrastructure/index.ts
#   - apps/api/src/modules/debug/debug.controller.ts
#   - apps/api/src/modules/debug/debug.module.ts
#   - apps/api/src/modules/debug/index.ts
#
#   NEW FILES - DOCKER & DEPLOYMENT:
#   - apps/api/Dockerfile (multi-stage production build)
#   - apps/api/.dockerignore (reduces build context size)
#   - .dockerignore (monorepo root)
#   - railway.json (Railway deployment config)
#   - RAILWAY.md (complete deployment guide)
#
#   MODIFIED FILES:
#   - apps/api/src/main.ts
#     â†’ Added Sentry.init() at top (before all imports)
#     â†’ Added graceful shutdown (enableShutdownHooks)
#     â†’ Added unhandled error handlers
#     â†’ Excluded health routes from /api prefix
#   - apps/api/src/app.module.ts
#     â†’ Imported: HealthModule, SentryModule, CustomThrottlerModule, DebugModule
#   - apps/api/src/config/configuration.ts
#     â†’ Added sentry config section
#     â†’ Added throttler config section
#   - apps/api/package.json
#     â†’ Added @sentry/nestjs, @sentry/profiling-node dependencies
#     â†’ Added db:migrate:deploy, db:migrate:create scripts
#   - .github/workflows/ci.yml
#     â†’ Fixed: Changed from PNPM to Yarn
#     â†’ Added lint and type-check steps
#   - apps/api/.env.example (this file)
#     â†’ Added SENTRY_* variables
#     â†’ Added THROTTLER_* variables
#     â†’ Added comprehensive setup documentation
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  ğŸ“ TODO: COMPLETE SETUP ON MAC                                            â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   STEP 1: MERGE ENVIRONMENT VARIABLES
#   [ ] Copy your existing apps/api/.env from Mac to this Windows machine
#   [ ] Add these NEW variables to your Mac .env file:
#       - SENTRY_DSN=https://b481c1ffbec1d8acf87d7fb750d78cbc@o4510664962211840.ingest.us.sentry.io/4510664990523392
#       - SENTRY_ENVIRONMENT=development
#       - SENTRY_TRACES_SAMPLE_RATE=1.0
#       - SENTRY_PROFILES_SAMPLE_RATE=1.0
#       - THROTTLER_SHORT_TTL=1000
#       - THROTTLER_SHORT_LIMIT=5
#       - THROTTLER_MEDIUM_TTL=10000
#       - THROTTLER_MEDIUM_LIMIT=30
#       - THROTTLER_LONG_TTL=60000
#       - THROTTLER_LONG_LIMIT=100
#   [ ] After merging, copy final .env back to .env.example (with secrets removed)
#
#   STEP 2: INSTALL DEPENDENCIES & TEST
#   [ ] cd apps/api && yarn install
#   [ ] docker-compose up -d
#   [ ] yarn workspace api start:dev
#   [ ] curl http://localhost:3000/health (should return healthy status)
#   [ ] curl http://localhost:3000/api/debug/sentry-test (should appear in Sentry)
#
#   STEP 3: CONFIGURE SENTRY ALERTS
#   [ ] Create 3 separate alerts in Sentry (see detailed guide above):
#       1. "New Issue Alert" - Catches new bugs immediately
#       2. "Error Spike Alert" - Catches volume spikes (50+ events/hour)
#       3. "User Impact Alert" - Catches widespread issues (10+ users/hour)
#   [ ] Set up Discord webhook integration
#   [ ] Send test notification to verify alerts work
#
#   STEP 4: TEST DOCKER BUILD (OPTIONAL)
#   [ ] cd apps/api
#   [ ] docker build -t crave-api:test .
#   [ ] docker run -p 3000:3000 --env-file .env crave-api:test
#   [ ] curl http://localhost:3000/health
#
#   STEP 5: PREPARE FOR RAILWAY DEPLOYMENT
#   [ ] Install Railway CLI: npm i -g @railway/cli
#   [ ] railway login
#   [ ] Create Railway project via dashboard (link GitHub repo)
#   [ ] Add PostgreSQL and Redis services
#   [ ] Set all environment variables (see Railway guide above)
#   [ ] railway link (link CLI to project)
#   [ ] railway run yarn workspace api db:migrate:deploy (first migration)
#   [ ] git push origin main (deploy!)
#
#   STEP 6: BEFORE PRODUCTION (CRITICAL!)
#   [ ] Remove DebugModule from apps/api/src/app.module.ts
#   [ ] Set production sample rates: SENTRY_TRACES_SAMPLE_RATE=0.1
#   [ ] Set production sample rates: SENTRY_PROFILES_SAMPLE_RATE=0.1
#   [ ] Set stricter rate limits: THROTTLER_SHORT_LIMIT=3, MEDIUM=20, LONG=60
#   [ ] Run: yarn workspace api lint (must be clean per AGENTS.md)
#   [ ] Verify Railway environment has NODE_ENV=production
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  âš ï¸  BEFORE PRODUCTION DEPLOYMENT CHECKLIST                                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#   SECURITY:
#   [ ] Remove DebugModule from app.module.ts
#   [ ] All secrets in Railway environment variables (not .env file)
#   [ ] NODE_ENV=production in Railway
#   [ ] Database connection uses SSL (Railway default)
#
#   PERFORMANCE:
#   [ ] Lower Sentry sample rates to 0.1 (10%)
#   [ ] Stricter rate limits in production
#   [ ] Redis connected for distributed throttling
#   [ ] Database connection pooling configured
#
#   MONITORING:
#   [ ] Sentry alerts configured (3 alerts recommended)
#   [ ] Discord webhook connected to Sentry
#   [ ] Railway health check endpoint set to /health
#   [ ] Test health endpoint returns 200
#
#   CODE QUALITY:
#   [ ] yarn workspace api lint (passes with zero no-unsafe-* errors)
#   [ ] yarn workspace api test (all tests passing)
#   [ ] yarn workspace api type-check (no TypeScript errors)
#   [ ] CI/CD passing on main branch
#
#   DEPLOYMENT:
#   [ ] Railway CLI installed and linked
#   [ ] Migration workflow tested (railway run yarn workspace api db:migrate:deploy)
#   [ ] Dockerfile builds successfully
#   [ ] All environment variables set in Railway
#   [ ] Custom domain configured (optional)
#
#   LEGAL (if not done already):
#   [âœ“] Privacy policy endpoint created at /privacy (Apple requires this)
#   [âœ“] Terms of service endpoint created at /terms (both stores require this)
#   [ ] Add URLs to app store listings:
#       - Privacy: https://your-domain.com/privacy
#       - Terms: https://your-domain.com/terms
#
# =============================================================================
# =============================================================================
#
#   STANDARD ENVIRONMENT VARIABLES BEGIN BELOW
#
# =============================================================================
# =============================================================================

# Environment namespace (recommended)
# - Use separate API keys per environment.
# - Prefer separate Redis instances per environment in production.
#
# NOTE: `.env` files do not expand variables automatically, so set full values.

# `dev` | `prod`
APP_ENV=dev

# Optional overrides (defaults derive from `APP_ENV`)
# BULL_PREFIX=crave:dev
# LLM_RATE_LIMIT_PREFIX=crave:dev:llm-rate-limiter

# Disable background schedulers (useful for test runs)
TEST_COLLECTION_JOBS_ENABLED=false
UNIFIED_PROCESSING_DRY_RUN=false
TEST_DRY_RUN=false

# LLM system instruction cache Redis key (selected by `APP_ENV`)
LLM_SYSTEM_CACHE_REDIS_KEY_DEV=crave:dev:llm:system-instruction-cache
LLM_SYSTEM_CACHE_REDIS_KEY_PROD=crave:prod:llm:system-instruction-cache
LLM_QUERY_RESULT_CACHE_REDIS_KEY_DEV=crave:dev:llm:query-analysis
LLM_QUERY_RESULT_CACHE_REDIS_KEY_PROD=crave:prod:llm:query-analysis

# LLM API key (selected by `APP_ENV`)
LLM_API_KEY_DEV=
LLM_API_KEY_PROD=
LLM_QUERY_TIMEOUT=0
LLM_QUERY_LOG_OUTPUTS=false
LLM_THINKING_ENABLED=true
LLM_THINKING_LEVEL=LOW
LLM_QUERY_THINKING_LEVEL=MINIMAL
LLM_THINKING_INCLUDE_THOUGHTS=false
LLM_THINKING_BUDGET=0
LLM_DEBUG_THOUGHTS_ONCE=false
LLM_DEBUG_THOUGHTS_QUERY=true
LLM_DEBUG_THOUGHTS_CONTENT=true
LLM_DEBUG_THOUGHTS_MAX_CHARS=0
LLM_DEBUG_THOUGHTS_MAX_QUERIES=1
LLM_DEBUG_THOUGHTS_MAX_CONTENT_CHUNKS=1
LLM_DEBUG_THOUGHTS_WRITE_FILE=false
LLM_DEBUG_THOUGHTS_FILE_PATH_QUERY=apps/api/logs/llm-thought-debug-query.json
LLM_DEBUG_THOUGHTS_FILE_PATH_CONTENT=apps/api/logs/llm-thought-debug-content.json
LLM_HEADERS_TIMEOUT_MS=120000
LLM_BODY_TIMEOUT_MS=300000
LLM_CONNECT_TIMEOUT_MS=30000
LLM_QUERY_RESULT_CACHE_TTL_SECONDS=0
LLM_QUERY_RESULT_CACHE_VERSION=v1
LLM_QUERY_RESULT_CACHE_LOCAL_TTL_SECONDS=0
LLM_QUERY_RESULT_CACHE_LOCAL_MAX_ENTRIES=0
LLM_QUERY_RESULT_CACHE_INCLUDE_METADATA=false
ENTITY_RESOLUTION_CACHE_REDIS_KEY_DEV=crave:dev:entity-resolution
ENTITY_RESOLUTION_CACHE_REDIS_KEY_PROD=crave:prod:entity-resolution
ENTITY_RESOLUTION_CACHE_TTL_SECONDS=0
ENTITY_RESOLUTION_CACHE_NEGATIVE_TTL_SECONDS=0
ENTITY_RESOLUTION_CACHE_LOCAL_TTL_SECONDS=0
ENTITY_RESOLUTION_CACHE_LOCAL_MAX_ENTRIES=0
ENTITY_RESOLUTION_CACHE_VERSION=v1

# Google Places API key (selected by `APP_ENV`)
GOOGLE_PLACES_API_KEY_DEV=
GOOGLE_PLACES_API_KEY_PROD=
GOOGLE_PLACES_TIMEOUT=10000
GOOGLE_PLACES_DEFAULT_RADIUS=5000

# Google Moderation API (selected by `APP_ENV`)
GOOGLE_MODERATION_API_KEY_DEV=
GOOGLE_MODERATION_API_KEY_PROD=
GOOGLE_MODERATION_ENDPOINT=https://contentmoderation.googleapis.com/v1beta/moderations:moderateText

# Reddit API credentials (selected by `APP_ENV`)
REDDIT_CLIENT_ID_DEV=
REDDIT_CLIENT_ID_PROD=
REDDIT_CLIENT_SECRET_DEV=
REDDIT_CLIENT_SECRET_PROD=
REDDIT_USERNAME_DEV=
REDDIT_USERNAME_PROD=
REDDIT_PASSWORD_DEV=
REDDIT_PASSWORD_PROD=

# Fail-fast circuit breakers (ignored in prod)
LLM_MAX_CONSECUTIVE_RATE_LIMITS=3
REDDIT_MAX_CONSECUTIVE_RATE_LIMITS=3

# Rank score refresh window (minutes)
RANK_SCORE_REFRESH_WINDOW_MINUTES=30

# Restaurant enrichment
RESTAURANT_ENRICHMENT_CONCURRENCY=5

# =============================================================================
# SENTRY - Error Tracking & Performance Monitoring
# =============================================================================
# Get your DSN from: https://sentry.io â†’ Project Settings â†’ Client Keys
# The DSN below is safe to commit (it's public-facing, Sentry has separate auth)
SENTRY_DSN=https://b481c1ffbec1d8acf87d7fb750d78cbc@o4510664962211840.ingest.us.sentry.io/4510664990523392
SENTRY_ENVIRONMENT=development
SENTRY_RELEASE=
# Sample rates (0.0 to 1.0)
# DEVELOPMENT: Use 1.0 (100%) to catch all errors during testing
# PRODUCTION: Use 0.1 (10%) to reduce costs while still monitoring effectively
SENTRY_TRACES_SAMPLE_RATE=1.0
SENTRY_PROFILES_SAMPLE_RATE=1.0
# For Railway production, set these in environment variables:
# SENTRY_TRACES_SAMPLE_RATE=0.1
# SENTRY_PROFILES_SAMPLE_RATE=0.1

# =============================================================================
# RATE LIMITING (Throttler)
# =============================================================================
# Protects API from abuse, DDoS attacks, and runaway clients
# Uses Redis for distributed rate limiting across multiple servers
#
# DEVELOPMENT VALUES (more lenient for testing):
# Short window: burst protection (1 second)
THROTTLER_SHORT_TTL=1000
THROTTLER_SHORT_LIMIT=5
# Medium window: 10 second window
THROTTLER_MEDIUM_TTL=10000
THROTTLER_MEDIUM_LIMIT=30
# Long window: 1 minute window  
THROTTLER_LONG_TTL=60000
THROTTLER_LONG_LIMIT=100
#
# PRODUCTION VALUES (stricter to prevent abuse):
# For Railway production, set these in environment variables:
# THROTTLER_SHORT_LIMIT=3   (was 5)
# THROTTLER_MEDIUM_LIMIT=20 (was 30)
# THROTTLER_LONG_LIMIT=60   (was 100)
# TTL values stay the same (1s, 10s, 60s)
